# 基于范围的ANN搜索方法

## 数据集说明

| 数据集 | 向量类型 | 维度 | 属性类型 |
|---------|-------------|-----|----------------|
| deep | 图像 | 96 | 合成数据 |
| youtube8m-audio | 音频 | 128 | 发布时间、观看次数 |
| youtube8m-rgb | 视频 | 1024 | 点赞数、评论数 |
| wit | 图像 | 1024 | 图片尺寸 |

## 实验结构
- `range0/`：查询范围为原数据大小的2^0倍
- `range1/`：查询范围为原数据大小的2^(-1)倍
- 每种方法的实验结果（QPS、Recall@10）单独存储为CSV文件

## 方法

### 1. IRange

IRange使用段树结构解决范围过滤ANN搜索问题。

#### 索引构建
- 将数据范围[1,n]在不同层次划分为不同长度的段
- 为每个段构建基于RNG的基础图
- 每个数据对象在每层只出现一次，最大度数为m

#### 查询处理
1. **动态图构建**
   - 仅在需要时构建边
   - 基于查询范围重叠度保留边
   - 优先选择与查询范围重叠度高的段

2. **边选择算法**
   - 自顶向下遍历段树
   - 跳过查询范围交集相同的层
   - 当段被查询范围完全覆盖时停止
   - 时间复杂度为O(m + log n)

3. **搜索策略**
   - 在动态图上执行贪心波束搜索
   - 仅访问满足范围约束的对象
   - 通过波束大小平衡效率与精度

#### 核心创新
- 避免为所有可能范围预构建图
- 将空间复杂度降至O(nm log n)
- 利用段树结构实现高效的实时图构建

### 2. SeRF

SeRF通过压缩多个HNSW索引实现高效的RFANNS查询。

#### 段图（Segment Graph）
处理半开范围查询：
- 将每个可能的查询范围映射到一个HNSW索引
- 通过无损压缩将所有HNSW索引合并为一个段图

构建过程：
1. 增量构建HNSW索引
2. 记录边的生命周期时间戳
3. 通过基于时间戳的边跟踪压缩所有索引

#### 二维段图（2D Segment Graph）
支持任意范围查询：
- 将多个段图合并为一个二维图
- 使用跳跃优化动态调整查询范围
- 用二维区间表示边的存在范围

构建过程：
1. 从第一个数据点开始初始化
2. 实现查询范围扩展的跳跃策略
3. 动态更新边的区间

### 3. ACORN

ACORN通过谓词子图遍历扩展HNSW。

#### ACORN-γ
对HNSW的修改：
1. **邻居列表扩展**
   - 使用M*γ个近似最近邻作为候选
   - M为标准HNSW参数
2. **索引压缩**
   - 保留Mβ个最近的候选邻居
   - 基于二跳邻居比较进行剪枝

搜索：
- 遍历直接邻居和二跳邻居
- 仅访问满足属性过滤条件的节点

#### ACORN-1
- 在最小索引大小下近似ACORN-γ性能
- 在搜索过程中执行邻域扩展
- 使用γ = 1和Mβ = M的原始HNSW构建

#### 实现说明
- 使用标记数组进行节点过滤
- 通过修改标记数组条件支持复杂查询
